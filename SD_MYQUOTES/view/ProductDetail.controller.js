/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseDetailController");jQuery.sap.require("sap.ui.core.mvc.Controller");jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.ui.model.odata.Filter");jQuery.sap.require("sap.ca.ui.model.type.Number");sap.ca.scfld.md.controller.BaseDetailController.extend("cus.sd.myquotations.view.ProductDetail",{myCustomerId:null,myMaterialId:null,mySalesOrg:null,myDistChannel:null,myDivision:null,selectedUoM:null,isNavToMaster:false,qtyNotValid:false,onInit:function(){sap.ca.scfld.md.controller.BaseDetailController.prototype.onInit.call(this);var t=this;this.resourceBundle=this.oApplicationFacade.getResourceBundle();this.fullScreenMode=this.oApplicationFacade.getApplicationModel("global").getProperty("/fullScreenMode");this.getView().addEventDelegate({onBeforeShow:jQuery.proxy(function(e){t.updateCartSize()},this)});this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="product"){if(t.oApplicationFacade.getApplicationModel("NewQuotation")&&!jQuery.isEmptyObject(t.oApplicationFacade.getApplicationModel("NewQuotation").oData)){this.onNavProduct(e.getParameter("arguments").materialID)}else{this.isNavToMaster=true}}},this)},onNavProduct:function(m){var n=this.oApplicationFacade.getApplicationModel("NewQuotation");this.myCustomerId=n.getProperty("/SoldToParty");this.myDivision=n.getProperty("/Division");this.mySalesOrg=n.getProperty("/SalesOrganization");this.myDistChannel=n.getProperty("/DistributionChannel");this.myMaterialId=m;if(this.mySalesOrg&&this.myDistChannel&&this.myDivision&&this.myCustomerId&&this.myMaterialId){this.loadModel()}},loadModel:function(){var m=new sap.ui.model.json.JSONModel();var a=new sap.ui.model.json.JSONModel();var b=new sap.ui.model.json.JSONModel();var c=new sap.ui.model.json.JSONModel();var q=new sap.ui.model.json.JSONModel();c.setProperty("/enableAddToCart",false);q.setProperty("/value","1");this.getView().setModel(m,"MaterialDetail");this.getView().setModel(a,"MaterialPrice");this.getView().setModel(b,"MaterialUoMSet");this.getView().setModel(c,"buttons");this.getView().setModel(q,"Quantity");var s=this.getView().getModel();var e="MaterialSet(SalesOrganization='"+this.mySalesOrg+"',"+"DistributionChannel='"+this.myDistChannel+"',"+"MaterialId='"+this.myMaterialId+"')/MaterialDetail";var p=["$expand=MaterialUoMSet"];s.read(e,null,p,false,function(d,r){b.setData(d.MaterialUoMSet);b.updateBindings();d.UoM=d.BaseUoM;m.setData(d);m.updateBindings()},function(d,r){cus.sd.myquotations.util.ModelExtractor.dialogErrorMessage(d,r)});this.selectedUoM=this.getView().getModel("MaterialDetail").getProperty("/BaseUoM");this.updatePriceUoM(this.selectedUoM);this.updateCartSize();this.setGrossWeight()},setGrossWeight:function(){var r=this.getView().getModel("MaterialUoMSet").getProperty("/results");var g=0;for(var i=0;i<r.length;i++){if(this.selectedUoM===r[i].UoM){g=r[i].GrossWeight}}this.getView().byId("grossWeightText").setNumber(g)},onSwitchUoM:function(e){this.selectedUoM=e.getSource().getSelectedKey();this.updatePriceUoM(this.selectedUoM);this.setGrossWeight()},updatePriceUoM:function(u){var b=new sap.ui.model.json.JSONModel();b.setProperty("/enableAddToCart",false);this.getView().setModel(b,"buttons");var m=new sap.ui.model.json.JSONModel();this.getView().setModel(m,"MaterialPrice");var e="GetMaterialPrice";var p=["UoM='"+u+"'","Customer='"+this.myCustomerId+"'","Division='"+this.myDivision+"'","DistributionChannel='"+this.myDistChannel+"'","SalesOrganization='"+this.mySalesOrg+"'","MaterialId='"+this.myMaterialId+"'"];var s=this.getView().getModel();s.read(e,null,p,true,function(d,r){m.setData(d);m.updateBindings();b.setProperty("/enableAddToCart",true);b.updateBindings()},function(d,r){cus.sd.myquotations.util.ModelExtractor.dialogErrorMessage(d,r)})},onAddToCart:function(e){if(!this.qtyNotValid){var n=this.oApplicationFacade.getApplicationModel("NewQuotation");var i=n.getProperty("/QuotationItemSet");var a=this._buildItem();if(this.getView().getModel("Quantity").getProperty("/value")>0){a.ItemID=(cus.sd.myquotations.util.ModelExtractor.extractGreatestItemID(n.getProperty("/QuotationItemSet/results"))+10).toString();if(i&&i.results){a.PricingConditionSet.results[0].ItemID=a.ItemID;i.results[i.results.length]=a}else{a.PricingConditionSet.results[0].ItemID=a.ItemID;i={results:[a]}}n.setProperty("/QuotationItemSet",i);var m=this.resourceBundle.getText("MATERIAL_MSG_ADDED_TO_CAR");var o=this.getMessageToastOffset();var b=String(m.length+5)+"ex";sap.m.MessageToast.show(m,{width:b,duration:5000,my:"right top",at:"left top",offset:o});this.updateCartSize()}else{sap.m.MessageBox.show(this.resourceBundle.getText("ENTER_VALID_QUANTITY"),sap.m.MessageBox.Icon.WARNING)}}},onAfterRendering:function(){if(this.isNavToMaster){this.isNavToMaster=false;this.oRouter.navTo("master",undefined,true)}},formChangedInputQuantity:function(e){var m=this.resourceBundle.getText("ENTER_VALID_QUANTITY");this.qtyNotValid=cus.sd.myquotations.util.ModelExtractor.validationInputQuantity(e,m)},updateCartSize:function(){this.getView().byId("cartButton").setText("("+this.getCartSize()+")")},getCartSize:function(){var s=this.oApplicationFacade.getApplicationModel("NewQuotation");var d=s?s.getProperty("/QuotationItemSet/results"):[];return d?d.length:0},_buildItem:function(){var i=this.oApplicationFacade.getApplicationModel("customizing").getProperty("/ITEM_PRICE");return{ItemID:"",ItemDescription:this.getView().getModel("MaterialDetail").getProperty("/MaterialDescription"),MaterialNumber:this.getView().getModel("MaterialDetail").getProperty("/MaterialId"),OrderQuantity:this.getView().getModel("Quantity").getProperty("/value"),SalesUnit:this.selectedUoM,PricingConditionSet:{results:[{ItemID:"",CondTypeCode:i,Counter:"000",AmountInternal:this.getView().getModel("MaterialPrice").getProperty("/Price")}]},MaterialUoMSet:this.getView().getModel("MaterialUoMSet").getData()}},onCancel:function(){var t=this;sap.m.MessageBox.show(this.resourceBundle.getText("LOOSEALLCHANGES"),sap.m.MessageBox.Icon.WARNING,this.resourceBundle.getText("WARNING"),[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(e){if(e===sap.m.MessageBox.Action.OK){var l=t.oApplicationFacade.getApplicationModel("global").getProperty("/lastQuotationID");if(t.fullScreenMode)window.history.back(1);else if(l===undefined||jQuery.device.is.phone){t.oRouter.navTo("master")}else{t.oRouter.navTo("detail",{contextPath:l},false)}}})},goToCreateQuotation:function(){if(this.fullScreenMode)this.oRouter.navTo("cart",null,true);else this.oRouter.navTo("cart")},getMessageToastOffset:function(){var e=this.findCartButtonElement();var r=$(e).offset().left+75;var t=$(e).offset().top+50;return r+" "+t},findCartButtonElement:function(){var e=$(document.getElementsByTagName("Button"));for(var i=0,l=e.length;i<l;i++){if(e[i].id.indexOf("cartButton")!==-1){return e[i]}}}});
