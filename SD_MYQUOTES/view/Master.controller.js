/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.ScfldMasterController");jQuery.sap.require("sap.ui.core.mvc.Controller");jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.ui.model.odata.Filter");jQuery.sap.require("sap.ca.ui.CustomerContext");sap.ca.scfld.md.controller.ScfldMasterController.extend("cus.sd.myquotations.view.Master",{filterValueArray:[],searchString:"",sliderMax:30,expiryFilterStateMap:{},onInit:function(){sap.ca.scfld.md.controller.ScfldMasterController.prototype.onInit.call(this);this.resourceBundle=this.oApplicationFacade.getResourceBundle();this.getView().getModel().setCountSupported(false);this.oApplicationFacade.setApplicationModel("global",new sap.ui.model.json.JSONModel());this.oApplicationFacade.setApplicationModel("customizing",new sap.ui.model.json.JSONModel());var s=this;var a=this.getView().getModel();a.read("CustomizingSet",undefined,undefined,false,function(d,r){var b=(d&&d.results&&d.results[0])?d.results[0]:s.getDefaultCustomizingSet();s.oApplicationFacade.getApplicationModel("customizing").setData(b)},function(d,r){cus.sd.myquotations.util.ModelExtractor.dialogErrorMessage(d,r)});this.getList().bindItems(this.createMasterBindingInfo());this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")==="master"){this.onNavMaster()}},this);this.buildCustomerContext();this.buildFilterDialog();this.buildSortDialog()},getDefaultCustomizingSet:function(){return{HEAD_DISCOUNT:"HA00",ITEM_DISCOUNT:"RA00",ITEM_PRICE:"PR00",PARTNER:"SE",QUOTE_TYPE:"QT"}},onNavMaster:function(){},onBeforeRendering:function(){},applyFilterFromContext:function(c){},onDataLoaded:function(){var c=sap.ui.core.Component.getOwnerIdFor(this.getView());var C=sap.ui.component(c);var o=C?C.getComponentData():null;var Q=null;if(o&&o.startupParameters&&!this._hashParam){jQuery.sap.log.info("app was started with parameters "+JSON.stringify(o.startupParameters));if(o.startupParameters.QuotationID&&o.startupParameters.QuotationID[0]){Q=o.startupParameters.QuotationID[0]}if(o.startupParameters.SalesQuotation&&o.startupParameters.SalesQuotation[0]){Q=o.startupParameters.SalesQuotation[0]}}if(Q&&!this._hashParam){this.oRouter.navTo("detail",{contextPath:Q},!jQuery.device.is.phone)}sap.ca.scfld.md.controller.ScfldMasterController.prototype.onDataLoaded.call(this)},setListItem:function(i){this.getList().removeSelections();if(i){i.setSelected(true);this.getList().setSelectedItem(i,true);this.oRouter.navTo("detail",{contextPath:i.getBindingContext().getProperty("QuotationID")},!jQuery.device.is.phone)}},getBindingContextPathFor:function(e){if(e.contextPath===undefined){jQuery.sap.log.warning("The context path was undefined.");return undefined}return"/QuotationSet('"+e.contextPath+"')"},resolveHash:function(e){var q=e.getParameter("arguments").contextPath;return"/QuotationSet('"+q+"')"},buildCustomerContext:function(){var s=this;this.oCustomerContextDialog=new sap.ca.ui.CustomerContext({dialogTitle:s.resourceBundle.getText("SELECTCUSTOMER_TITLE"),showSalesArea:true,customerIDProperty:'CustomerID',customerNameProperty:'CustomerName',salesOrganizationNameProperty:'SalesOrganizationName',distributionChannelNameProperty:'DistributionChannelName',divisionNameProperty:'DivisionName',customerSelected:function(e){var h=s.oApplicationFacade.getApplicationModel("customizing").getProperty("/HEAD_DISCOUNT");var c=new sap.ui.model.json.JSONModel();var p=[{PartnerNumber:e.getParameter("CustomerID"),PartnerFunction:"AG"}];var a={results:p};c.setProperty("/PartnerSet",a);c.setProperty("/SoldToParty",e.getParameter("CustomerID"));c.setProperty("/SalesOrganization",e.getParameter("SalesOrganization"));c.setProperty("/DistributionChannel",e.getParameter("DistributionChannel"));c.setProperty("/Division",e.getParameter("Division"));c.setProperty("/RequestedDeliveryDate",cus.sd.myquotations.util.ModelExtractor.currentDateTime());c.setProperty("/ValidTo",cus.sd.myquotations.util.ModelExtractor.currentDateTime());c.setProperty("/ValidFrom",cus.sd.myquotations.util.ModelExtractor.currentDateTime());c.setProperty("/PurchaseOrder","");var b=[{ItemID:"000000",CondTypeCode:h,Counter:"000",AmountInternal:"0.0"}];var d={results:b};c.setProperty("/PricingConditionSet",d);s.oApplicationFacade.setApplicationModel("NewQuotation",c);if(jQuery.device.is.phone){s.oRouter.navTo("products")}else{s.oRouter.navTo("productEmpty");s.oRouter.navTo("products",undefined,true)}}});this.oCustomerContextDialog.setPath("/CustomerSet");setTimeout(function(){s.oCustomerContextDialog.setModel(s.getView().getModel())},1500)},onNew:function(e){this.oCustomerContextDialog.change()},buildSortDialog:function(){var s=this;this.sortDialog=new sap.m.ViewSettingsDialog({sortDescending:true,confirm:function(e){var p=e.getParameters(),S=null;if(p.sortItem){S=p.sortItem.getCustomData()[0].getValue();if(S){S.bDescending=p.sortDescending;var o=new sap.ui.model.Sorter("QuotationID",p.sortDescending);s.getList().getBinding("items").sort([S,o])}}}});this.sortDialog.addSortItem(new sap.m.ViewSettingsItem({key:"expiryDateSorter",text:s.resourceBundle.getText("SORT_EXPIRY_DATE"),customData:new sap.ui.core.CustomData({key:"sorter",value:new sap.ui.model.Sorter("ValidTo",false)})}));this.sortDialog.addSortItem(new sap.m.ViewSettingsItem({key:"netValueSorter",text:s.resourceBundle.getText("SORT_AMOUNT"),customData:new sap.ui.core.CustomData({key:"sorter",value:new sap.ui.model.Sorter("NetValue",false)})}));this.sortDialog.addSortItem(new sap.m.ViewSettingsItem({key:"statusSorter",text:s.resourceBundle.getText("SORT_STATUS"),customData:new sap.ui.core.CustomData({key:"sorter",value:new sap.ui.model.Sorter("ProcessingStatus",false)})}));this.sortDialog.addSortItem(new sap.m.ViewSettingsItem({key:"creationDateSorter",text:s.resourceBundle.getText("SORT_CREATION_DATE"),selected:true,customData:new sap.ui.core.CustomData({key:"sorter",value:new sap.ui.model.Sorter("CreatedOn",true)})}));this.sortDialogLoaded=true},openSortDialog:function(){if(!this.sortDialogLoaded){this.buildSortDialog()}this.sortDialog.open()},buildFilterDialog:function(){var s=this;var a=function(E){if(E.getParameter("id").indexOf("dxpRB")>-1&&E.getParameter("selected")){s.getView().byId("daysSlider").setEnabled(true)}else{s.getView().byId("daysSlider").setEnabled(false)}s.getView().byId("expFilterItem").setSelected(true)};var c=new sap.m.VBox({items:[new sap.m.RadioButton(s.getView().createId("expRB"),{text:s.resourceBundle.getText("FILTER_EXPIRY_EXPIRED"),groupName:"expirationRB",select:a}),new sap.m.RadioButton(s.getView().createId("nxpRB"),{text:s.resourceBundle.getText("FILTER_EXPIRY_UNEXPIRED"),groupName:"expirationRB",select:a}),new sap.m.RadioButton(s.getView().createId("dxpRB"),{text:s._getNumDaysTextForFilter(s._getSliderDefaultValue()),groupName:"expirationRB",select:a}),new sap.m.Slider(s.getView().createId("daysSlider"),{value:s._getSliderDefaultValue(),min:0,max:s.sliderMax,step:1,progress:true,enabled:false,liveChange:function(E){var I=E.getSource().getParent().getItems();for(var i=0;i<I.length;i++){if(I[i].getId().indexOf("dxpRB")>-1){I[i].setText(s._getNumDaysTextForFilter(E.getParameter("value")));I[i].setSelected(true);break}}}})]});var e=function(C){var f=[],I=C.getItems(),t=new Date(),b=new Date(),n=0,d="";for(var i=0;i<I.length;i++){if(I[i]instanceof sap.m.RadioButton&&I[i].getSelected()){d=I[i].getId()}else if(I[i].getId().indexOf("daysSlider")>-1){n=I[i].getValue()}}if(d.indexOf("expRB")>-1){f.push(new sap.ui.model.Filter('ValidTo',sap.ui.model.FilterOperator.LT,t))}else if(d.indexOf("nxpRB")>-1){f.push(new sap.ui.model.Filter('ValidTo',sap.ui.model.FilterOperator.GE,t))}else if(d.indexOf("dxpRB")>-1){b.setDate(t.getDate()+n);f.push(new sap.ui.model.Filter('ValidTo',sap.ui.model.FilterOperator.BT,t,b))}return f};this.filterDialog=new sap.m.ViewSettingsDialog({confirm:function(E){s.filterValueArray.length=0;var p=E.getParameters(),f,C;for(var i=0;i<p.filterItems.length;i++){if(p.filterItems[i]instanceof sap.m.ViewSettingsCustomItem){C=p.filterItems[i].getCustomData()[0].getValue();f=C.apply(this,[p.filterItems[i].getCustomControl()]);if(f){if(!Array.isArray(f)){f=[f]}s.filterValueArray=s.filterValueArray.concat(f)}}else if(p.filterItems[i]instanceof sap.m.ViewSettingsItem){f=p.filterItems[i].getCustomData()[0].getValue();if(f){if(!Array.isArray(f)){f=[f]}s.filterValueArray=s.filterValueArray.concat(f)}}}s._updateList(s.getList().getBinding("items"));s.getView().byId("infoBarToolbar").setVisible((s.filterValueArray.length>0)?true:false);s.getView().byId("infoBarFilter").setText((s.filterValueArray.length>0)?p.filterString:"");s._setExpiryFilterState()}});this.filterDialog.addFilterItem(new sap.m.ViewSettingsCustomItem(s.getView().createId("expFilterItem"),{key:"expiryFilter",text:s.resourceBundle.getText("FILTER_EXPIRY"),customControl:c,customData:new sap.ui.core.CustomData({key:"callback",value:e})}));this.filterDialog.addFilterItem(new sap.m.ViewSettingsFilterItem({key:"statusFilter",text:s.resourceBundle.getText("FILTER_STATUS"),items:[new sap.m.ViewSettingsItem({key:"openStatus",text:s.resourceBundle.getText("STATUS_OPEN"),customData:new sap.ui.core.CustomData({key:"filter",value:new sap.ui.model.Filter("ProcessingStatus",sap.ui.model.FilterOperator.EQ,"A")})}),new sap.m.ViewSettingsItem({key:"inprocessStatus",text:s.resourceBundle.getText("STATUS_INPROCESS"),customData:new sap.ui.core.CustomData({key:"filter",value:new sap.ui.model.Filter("ProcessingStatus",sap.ui.model.FilterOperator.EQ,"B")})}),new sap.m.ViewSettingsItem({key:"completedStatus",text:s.resourceBundle.getText("STATUS_COMPLETED"),customData:new sap.ui.core.CustomData({key:"filter",value:new sap.ui.model.Filter("ProcessingStatus",sap.ui.model.FilterOperator.EQ,"C")})})]}));this.filterDialog.addFilterItem(new sap.m.ViewSettingsFilterItem({key:"rejStatusFilter",text:s.resourceBundle.getText("FILTER_REJ_STATUS"),items:[new sap.m.ViewSettingsItem({key:"notRejStatus",text:s.resourceBundle.getText("STATUS_NOT_REJ"),customData:new sap.ui.core.CustomData({key:"filter",value:new sap.ui.model.Filter("RejectionStatus",sap.ui.model.FilterOperator.EQ,"A")})}),new sap.m.ViewSettingsItem({key:"partRejStatus",text:s.resourceBundle.getText("STATUS_PART_REJ"),customData:new sap.ui.core.CustomData({key:"filter",value:new sap.ui.model.Filter("RejectionStatus",sap.ui.model.FilterOperator.EQ,"B")})}),new sap.m.ViewSettingsItem({key:"allRejStatus",text:s.resourceBundle.getText("STATUS_ALL_REJ"),customData:new sap.ui.core.CustomData({key:"filter",value:new sap.ui.model.Filter("RejectionStatus",sap.ui.model.FilterOperator.EQ,"C")})})]}));this.filterDialog.attachResetFilters(function(){s._resetFilterControl()});this.filterDialog.attachCancel(function(){s.getView().byId("dxpRB").setText(s.expiryFilterStateMap.dxpRBText);s.getView().byId("daysSlider").setValue(s.expiryFilterStateMap.sliderValue);s.getView().byId("daysSlider").setEnabled(s.expiryFilterStateMap.dxpRBSelected);s.getView().byId("expRB").setSelected(s.expiryFilterStateMap.expRBSelected);s.getView().byId("nxpRB").setSelected(s.expiryFilterStateMap.nxpRBSelected);s.getView().byId("dxpRB").setSelected(s.expiryFilterStateMap.dxpRBSelected);s.getView().byId("expFilterItem").setSelected(s.expiryFilterStateMap.expFilterItemSelected)});this._setExpiryFilterState();this.filterDialogLoaded=true},openFilterDialog:function(){if(!this.filterDialogLoaded){this.buildFilterDialog()}this.filterDialog.open()},_resetFilterControl:function(){var s=this._getSliderDefaultValue();var a=this._getNumDaysTextForFilter(s);this.getView().byId("dxpRB").setText(a);this.getView().byId("daysSlider").setValue(s);this.getView().byId("daysSlider").setEnabled(false);this.getView().byId("expRB").setSelected(false);this.getView().byId("nxpRB").setSelected(false);this.getView().byId("dxpRB").setSelected(false);this.filterDialog.setSelectedFilterKeys({openStatus:false,inprocessStatus:false,completedStatus:false,notRejStatus:false,partRejStatus:false,allRejStatus:false});this.getView().byId("expFilterItem").setSelected(false)},_setExpiryFilterState:function(){this.expiryFilterStateMap.dxpRBText=this.getView().byId("dxpRB").getText();this.expiryFilterStateMap.sliderValue=this.getView().byId("daysSlider").getValue();this.expiryFilterStateMap.expRBSelected=this.getView().byId("expRB").getSelected();this.expiryFilterStateMap.nxpRBSelected=this.getView().byId("nxpRB").getSelected();this.expiryFilterStateMap.dxpRBSelected=this.getView().byId("dxpRB").getSelected();this.expiryFilterStateMap.expFilterItemSelected=this.getView().byId("expFilterItem").getSelected()},clearFilters:function(){this._resetFilterControl();this._setExpiryFilterState();this.filterValueArray.length=0;this.getView().byId("infoBarFilter").setText("");this.getView().byId("infoBarToolbar").setVisible(false);this._updateList(this.getList().getBinding("items"))},_updateList:function(b){var f=[];if(this.searchString&&this.searchString.length>0){var a=new sap.ui.model.Filter("Search/SearchTerm",sap.ui.model.FilterOperator.EQ,this.searchString);f.push(a)}if(this.filterValueArray.length>0){f=f.concat(this.filterValueArray)}b.filter(f)},_getNumDaysTextForFilter:function(n){var a="";if(n<1){a=this.resourceBundle.getText("FILTER_EXPIRY_DAYS_TODAY")}else if(n===1){a=this.resourceBundle.getText("FILTER_EXPIRY_DAYS_TOMORROW")}else if(n>1){a=this.resourceBundle.getText("FILTER_EXPIRY_DAYS_IN",[n])}return a},_getSliderDefaultValue:function(){var r=this.oApplicationFacade.getApplicationModel("customizing").getProperty("/RED_THRESHOLD");if(r>this.sliderMax){return this.sliderMax}return r},createMasterBindingInfo:function(){var t=this.getList().getItems()[0].clone();var s=new sap.ui.model.Sorter("CreatedOn",true);var S=new sap.ui.model.Sorter("QuotationID",true);return{path:"/QuotationSet",template:t,sorter:[s,S],filters:undefined,parameters:{select:"QuotationID,NetValue,Currency,ValidTo,SoldToPartyDescription,ProcessingStatusDesc,ProcessingStatus,SalesDocumentTypeDesc"}}},isBackendSearch:function(){return true},applyBackendSearchPattern:function(f,b){this.searchString=f;if(this.getList().getBinding("items").bPendingRequest===false){this._updateList(b)}},getHeaderFooterOptions:function(){var t=this;return{sI18NMasterTitle:"MASTER_TITLE",oSortOptions:{onSortPressed:function(e){t.openSortDialog()}},oFilterOptions:{onFilterPressed:function(e){t.openFilterDialog()}},onAddPress:function(){t.onNew()}}}});
